#!/bin/bash
set -e

LOG_FILE="${TRIM_PKGVAR}/cmd.log"

DATA_DIR="${TRIM_PKGVAR}/data"
CFG_FILE="${DATA_DIR}/config.json"

log_msg() {
    if [ ! -d "${TRIM_PKGVAR}" ]; then
        mkdir -p "${TRIM_PKGVAR}"
    fi
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> ${LOG_FILE}
}

str_trim() {
    local str="$1"
    str="${str#"${str%%[![:space:]]*}"}"   # 去除首空格
    str="${str%"${str##*[![:space:]]}"}"  # 去除尾空格
    echo "$str"
}

alarm_and_exit() {
    # 在应用启动、安装、更新等过程中遇到错误时，可以向 TRIM_TEMP_LOGFILE 写入错误信息，然后退出脚本并返回错误码 1
    # 系统会自动将错误日志在前端展示为用户可见的内容（Dialog对话框形式）
    log_msg "$1"
    echo "$1" > "${TRIM_TEMP_LOGFILE}"
    exit 1
}

check_port_in_use() {
    local port=$1
    # Linux 用 ss，没有 ss 再用 netstat
    if command -v ss >/dev/null 2>&1; then
        ss -tln | grep -q ":$port "
    elif command -v netstat >/dev/null 2>&1; then
        netstat -tln | grep -q ":$port "
    else
        # 都检测不到就保守一点：当“未占用”继续往下走
        return 1
    fi
}
